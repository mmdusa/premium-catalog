/* src/components/CircularGallery.css */

/* These are the variables this component uses. */
@property --k {
  syntax: "<number>";
  initial-value: -1;
  inherits: true;
}

@property --ang {
  syntax: "<angle>";
  initial-value: 0deg;
  inherits: false;
}

/* Main wrapper for the entire gallery section */
.gallery-wrapper {
  /* This makes the container tall enough to scroll through all items */
  height: calc(var(--n) * 100vh);
  position: relative;
  /* New: Establishes a context for the sticky scene */
  overflow-y: scroll;
  /* New: Make this wrapper the scroll container */
  scrollbar-width: none;
  /* Hide scrollbar */
  color: #dedede;
  background: #121212;
  /* Fallback background */
}

.gallery-wrapper::-webkit-scrollbar {
  display: none;
  /* Hide scrollbar for Chrome/Safari */
}

/* The sticky container that holds the 3D scene */
.gallery-scene {
  display: grid;
  position: sticky;
  /* New: This is key. It sticks to the top of the wrapper */
  top: 0;
  width: 100%;
  height: 100vh;
  overflow: hidden;
  /* Clips the 3D content */
  perspective: 50em;

  /* This animation is now driven by the scroll of .gallery-wrapper */
  animation: gallery-scroll-progress 1s linear forwards;
  animation-timeline: scroll(root);
}

@keyframes gallery-scroll-progress {
  to {
    --k: 1;
  }
}

/* The assembly that rotates */
.gallery-assembly {
  display: grid;
  transform-style: preserve-3d;
  place-self: center;
  --w: clamp(4em, min(50vh, 25vw), 18em);
  --z: calc(-0.5 * var(--w) / tan(0.5turn / var(--n)));

  translate: 0 0 var(--z);
  rotate: 0 1 0 calc((var(--k) + 0.5) * -1turn);
}

/* Individual card */
.gallery-article {
  grid-area: 1 / 1;
  display: grid;
  transform-style: preserve-3d;
  width: var(--w);
  aspect-ratio: 2 / 3;

  /* Math to determine which card is "active" */
  --j: var(--i) / var(--n);
  --dif-lin: calc(var(--j) - mod(var(--k) + 1, 1));
  --abs-lin: max(var(--dif-lin), -1 * var(--dif-lin));
  --dif-mid: calc(0.5 - var(--abs-lin));
  --abs-mid: max(var(--dif-mid), -1 * var(--dif-mid));
  --dif-arc: calc(2 * (0.5 - var(--abs-mid)));
  --lim: 0.35;
  --sel: max(0, calc((var(--lim) - var(--dif-arc)) / var(--lim)));
  --out: calc(1 - var(--sel));
  --hov: 0;

  transform: rotate3d(0, 1, 0, calc(var(--j) * 1turn)) translatez(var(--z));
}

.gallery-article:hover {
  --hov: round(var(--sel));
}

/* Front and back faces of the card */
.gallery-article-header,
.gallery-article-figure {
  grid-area: 1 / 1;
  --ang: calc(-45deg + var(--hov) * 180deg);
  overflow: hidden;
  position: relative;
  border: solid 4px #0000;
  border-radius: 0.5em;
  backface-visibility: hidden;
  box-shadow: 5px 5px 13px #000;
  background: var(--url) var(--pos, 50%) / cover padding-box,
    linear-gradient(#666 0 0) padding-box,
    repeating-conic-gradient(from var(--ang),
      #0000 0% 15%,
      color-mix(in srgb, #c0a062 calc(var(--sel) * 100%), #333) 20% 30%,
      #0000 35% 50%) border-box #121212;
  background-blend-mode: multiply, normal, normal;
  isolation: isolate;
  pointer-events: none;
  transition: 0.35s ease-out;
  transition-property: transform, --ang;
}

.gallery-article-header {
  transform: rotateY(calc((1 + var(--hov)) * 0.5turn));
}

.gallery-article-figure {
  transform: rotateY(calc(var(--hov) * 0.5turn));
}

.gallery-article-header::after {
  position: absolute;
  inset: 0;
  opacity: var(--out);
  background: #03071e;
  mix-blend-mode: color;
  pointer-events: none;
  content: "";
}

/* Card Content Styling */
.gallery-article h2,
.gallery-article em,
.gallery-article-figure,
.gallery-article-header,
.gallery-article img {
  pointer-events: auto;
}

.gallery-article h2,
.gallery-article em {
  place-self: center;
  text-align: center;
  max-width: 80%;
  opacity: round(var(--sel));
  text-shadow: 1px 1px 1px #0006;
  text-wrap: balance;
}

.gallery-article h2 {
  font-family: var(--font-display);
  /* Using your existing font */
  font-size: 1.5em;
  color: var(--cream);
}

.gallery-article em {
  font-size: 1em;
  color: var(--gold);
}

.gallery-article img {
  width: 100%;
  height: 100%;
  aspect-ratio: 2/3;
  object-fit: cover;
}

/* Grain SVG Filter */
.grain-filter {
  position: fixed;
  width: 100%;
  height: 100vh;
  inset: 0;
  z-index: 10;
  background: #000;
  filter: url(#grain);
  mix-blend-mode: screen;
  opacity: 0.1;
  pointer-events: none;
}